name: ocf-util
version: 1.1.1-3+
summary: Utilities for testing OCF devices
description:
  This snap installs iotivity-node and iot-rest-api-server node modules
  for testing OCF implementations using Javascript.
confinement: strict
grade: devel

apps:
  start-iot-rest-api-server:
    command: env \
      LD_LIBRARY_PATH=$SNAP/lib/node_modules/iot-rest-api-server/node_modules/iotivity-node/deps/iotivity/lib:$LD_LIBRARY_PATH \
      NODE_PATH=$SNAP/lib/node_modules/iot-rest-api-server/node_modules \
      node $SNAP/lib/node_modules/iot-rest-api-server/index.js
    daemon: simple
    plugs: [ network-bind ]

  node:
    command: env \
      LD_LIBRARY_PATH=$SNAP/lib/node_modules/iot-rest-api-server/node_modules/iotivity-node/deps/iotivity/lib:$LD_LIBRARY_PATH \
      NODE_PATH=$SNAP/lib/node_modules/iot-rest-api-server/node_modules \
      node
    plugs: [ home, network-bind ]

parts:
  # Part builds from local source
  local:
    plugin: nil
    source: .

  # Part installs iotivity, iotivity-node, iot-rest-api-server
  meta-iot-web:
    plugin: nodejs
    node-packages:
      # HEAD: All: Use POST for update
      - 01org/iot-rest-api-server#77c8249877
      # HEAD: Tests: Remove API tests and use OS-agnostic termination for the rest
      - otcshare/iotivity-node#53249fcd62
    filesets:
      exports:
        # ignore the following files during staging
        - -CHANGELOG.md
        - -LICENSE
        - -README.md
    organize:
      # replace the iotivity-node with the specified snapshot
      lib/node_modules/iotivity-node: lib/node_modules/iot-rest-api-server/node_modules/iotivity-node
    install:
      # drop the iotivity-node associated with the iot-rest-api-server before staging
      rm -rf $SNAPCRAFT_PART_INSTALL/lib/node_modules/iot-rest-api-server/node_modules/iotivity-node
    stage: [ $exports ]
    snap:  [ $exports ]

